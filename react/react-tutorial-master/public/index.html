<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

    <!-- in-browser JSX transpiler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.16/browser.js"></script>

    <!-- 3rd party library that takes Markdown text and converts it to raw HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remarkable/1.6.2/remarkable.min.js"></script>
  </head>
  <body>
    <div id="content"></div>

    <!-- engages the in-browser Babel JSX transpiler; pre-transpiled JSX will be used in production-->
    <script type="text/babel">

      /*
       React.createClass() creates a component class, given a specification.
       A component implements a render method which returns one single child.
       That child may have an arbitrarily deep child structure (tree of React components).
       One thing that makes components different than standard prototypal classes is that you don't need to call new on them.
       They are convenience wrappers that construct backing instances (via new) for you.
       */
      var CommentBox = React.createClass({
        /*
         getInitialState() executes exactly once during the lifecycle of the component and
         sets up the initial state of the component.
         props are immutable: they are passed from the parent and are "owned" by the parent.
         To implement interactions, we introduce mutable state to the component.
         'this.state' is private to the component and can be changed by calling 'this.setState()'.
         When the state updates, the component re-renders itself.
         */
        getInitialState : function(){
          return {data:[]};
        },

        /* componentDidMount() is a method called automatically by React after a component
        is rendered for the first time.
        */
        componentDidMount: function() {
          this.loadCommentsFromServer();
          setInterval(this.loadCommentsFromServer, this.props.pollInterval);
        },

        /*
         returns a tree of React components that will eventually render to HTML.
         */
        render: function(){
          return (
            <div className="commentBox">
              <h1>Comments</h1>
              <CommentList data={this.state.data}/>
              <CommentForm onCommentSubmit={this.handleCommentSubmit} />
            </div>
          );
        },

        loadCommentsFromServer: function() {
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            cache: false,
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },

        handleCommentSubmit: function(comment) {
          var comments = this.state.data;
          // Optimistically set an id on the new comment. It will be replaced by an
          // id generated by the server. In a production application you would likely
          // not use Date.now() for this and would have a more robust system in place.
          comment.id = Date.now();
          var newComments = comments.concat([comment]);
          this.setState({data: newComments});

          $.ajax({
            url: this.props.url,
            dataType: 'json',
            type: 'POST',
            data: comment,
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              this.setState({data: comments});
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });

        }
      });

      var CommentForm = React.createClass({

        getInitialState: function() {
          return {author: '', text: ''};
        },

        handleAuthorChange: function(e) {
          this.setState({author: e.target.value});
        },

        handleTextChange: function(e) {
          this.setState({text: e.target.value});
        },

        handleSubmit: function(e) {
          e.preventDefault();

          var author = this.state.author.trim();
          var text = this.state.text.trim();

          if (!text || !author) {
            return;
          }

          this.props.onCommentSubmit({author: author, text: text});
          this.setState({author: '', text: ''});
        },

        render: function() {
          return (
                  <form className="commentForm" onSubmit={this.handleSubmit}>
                    <input
                            type="text"
                            placeholder="Your name"
                            value={this.state.author}
                            onChange={this.handleAuthorChange}
                    />
                    <input
                            type="text"
                            placeholder="Say something..."
                            value={this.state.text}
                            onChange={this.handleTextChange}
                    />
                    <input type="submit" value="Post" />
                  </form>
          );
        }
      });

      var Comment = React.createClass({

        /*
         Remember: by using this feature you're relying on remarkable to be secure.
         In this case, remarkable automatically strips HTML markup and insecure links from the output.
         */
        rawMarkup: function() {
          var md = new Remarkable();
          /*
           Data passed in from a parent component is available as a 'property' on the child component.
           These 'properties' are accessed through 'this.props'
           */
          var rawMarkup = md.render(this.props.children.toString());
          return { __html: rawMarkup };
        },

        render : function(){
          return (
                  <div className="comment">
                    <h2 className="commentAuthor">
                      {this.props.author}
                    </h2>
                    <span dangerouslySetInnerHTML={this.rawMarkup()} />
                  </div>
          );
        }
      });

      var CommentList = React.createClass({
        render: function() {
          var commentNodes = this.props.data.map(function(comment){
            return (
                <Comment author={comment.author} key={comment.id}>
                  {comment.text}
                </Comment>
            );
          });
          return (
                <div className="commentList">
                  {commentNodes}
                </div>
          );
        }
      });

      ReactDOM.render(
              <CommentBox url="/api/comments" pollInterval={2000}/>,
              document.getElementById('content')
      );
    </script>
  </body>
</html>
